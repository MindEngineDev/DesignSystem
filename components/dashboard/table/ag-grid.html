<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AG Grid Demo — DesignSystem</title>
    <link rel="icon" href="/favicon.png" />
    <link rel="stylesheet" href="../../main.css" />
    <!-- Pico.css for baseline styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.*/css/pico.min.css" />
    <!-- Shoelace dark theme to preview components styling alongside grid -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2/dist/themes/dark.css" />
    <!-- AG Grid Community styles (pin to a single, modern version) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.3/styles/ag-grid.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.3/styles/ag-theme-alpine.min.css" />
    <style>
      body {
        padding: 1rem;
      }
      .page {
        max-width: 1100px;
        margin: 0 auto;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      #myGrid {
        height: 60vh;
        width: 100%;
      }
      .controls {
        margin-bottom: 0.5rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .muted {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #999;
      }
      .grid-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 0;
        color: var(--muted);
      }
      .grid-error {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 0;
        color: var(--danger, #c33);
      }
    </style>
    <link rel="stylesheet" href="./site.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace/dist/themes/dark.css" />
    <script>
      window.__shoelace_base_url = "https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace/dist/";
    </script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace/dist/shoelace.js"></script>
  </head>
  <body>
    <main class="container page">
      <header>
        <h1>AG Grid demo</h1>
        <nav>
          <a href="/pages/mobile.html">Mobile preview</a>
          <a href="/pages/manager-dashboard.html">Dashboard</a>
          <a href="/pages/cms.html">CMS</a>
        </nav>
      </header>

      <section x-data="agGridDemo()" x-init="init()">
        <div class="controls">
          <label>
            Filter:
            <input x-model="quickFilter" @input="onQuickFilter()" placeholder="quick filter..." />
          </label>
          <button @click="shuffle()">Shuffle rows</button>
          <button @click="addRow()">Add row</button>
        </div>

        <div id="myGrid" class="ag-theme-alpine"><div class="grid-loading">Loading…</div></div>
      </section>

      <p class="muted">This preview uses AG Grid Community via CDN and initializes the grid through Alpine.js. No local npm install required.</p>
    </main>

    <!-- AG Grid Community UMD bundle (pinned) -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.3/dist/ag-grid-community.min.noStyle.js"></script>
    <script>
      function agGridDemo() {
        return {
          gridApi: null,
          gridColumnApi: null,
          quickFilter: "",
          rowData: [],
          columnDefs: [{ field: "id", headerName: "ID", width: 90 }, { field: "make" }, { field: "model" }, { field: "price", headerClass: "numeric", valueFormatter: (params) => `$${params.value}` }],
          // Provide stable ids so AG Grid can perform delta updates efficiently
          getRowId: (params) => params.data.id,
          sampleRows() {
            return [
              { id: 1, make: "Toyota", model: "Celica", price: 35000 },
              { id: 2, make: "Ford", model: "Mondeo", price: 32000 },
              { id: 3, make: "Porsche", model: "Boxster", price: 72000 },
              { id: 4, make: "BMW", model: "5 Series", price: 59000 },
              { id: 5, make: "Audi", model: "A4", price: 42000 },
            ];
          },
          init() {
            const gridOptions = {
              columnDefs: this.columnDefs,
              rowData: this.sampleRows(),
              // enable delta row updates so we can use transactions for incremental changes
              deltaRowDataMode: true,
              getRowId: this.getRowId,
              onGridReady: (params) => {
                this.gridApi = params.api;
                this.gridColumnApi = params.columnApi;
              },
              defaultColDef: { sortable: true, filter: true, resizable: true },
            };

            const eGridDiv = document.querySelector("#myGrid");

            // Lazy-init the grid only when the element becomes visible to reduce initial CPU/work
            let _gridInitialized = false;
            const debounce = (fn, wait = 250) => {
              let t;
              return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), wait);
              };
            };
            const showGridError = (el, msg = "Grid failed to load") => {
              try {
                const loader = el.querySelector(".grid-loading");
                if (loader) loader.remove();
                const err = document.createElement("div");
                err.className = "grid-error";
                err.textContent = msg;
                el.appendChild(err);
              } catch (e) {
                /* ignore */
              }
            };
            const initGrid = () => {
              if (_gridInitialized) return;
              if (!eGridDiv) return;
              try {
                new agGrid.Grid(eGridDiv, gridOptions);
                // remove loader
                const loader = eGridDiv.querySelector(".grid-loading");
                if (loader) loader.remove();
                _gridInitialized = true;
                // attach debounced quick-filter if present inside same section
                try {
                  const section = eGridDiv.closest("section");
                  const q = section && section.querySelector('input[type="search"], input[placeholder]');
                  if (q && gridOptions && gridOptions.api) {
                    const deb = debounce(() => gridOptions.api.setQuickFilter(q.value || ""), 250);
                    q.addEventListener("input", deb);
                  }
                } catch (e) {
                  /* ignore */
                }
              } catch (err) {
                showGridError(eGridDiv, String(err?.message || "Grid initialization error"));
              }
            };

            if ("IntersectionObserver" in window && eGridDiv) {
              const obs = new IntersectionObserver(
                (entries, o) => {
                  entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                      initGrid();
                      o.disconnect();
                    }
                  });
                },
                { root: null, threshold: 0.05 }
              );
              obs.observe(eGridDiv);
              // Fallback in case the observer doesn't fire in some embed contexts
              setTimeout(() => {
                if (!_gridInitialized) initGrid();
              }, 300);
            } else {
              // immediate fallback
              initGrid();
            }
          },
          onQuickFilter() {
            if (this.gridApi) this.gridApi.setQuickFilter(this.quickFilter);
          },
          shuffle() {
            if (!this.gridApi) return;
            // For demo, resetting full rowData is ok; for large datasets prefer applyTransaction
            const rows = this.sampleRows().sort(() => Math.random() - 0.5);
            this.gridApi.setRowData(rows);
          },
          addRow() {
            if (!this.gridApi) return;
            const next = { id: Date.now() % 100000, make: "New", model: "Model", price: Math.floor(Math.random() * 90000) };
            // Use a transaction so AG Grid can update only the changed rows when deltaRowDataMode is enabled
            this.gridApi.applyTransaction({ add: [next] });
          },
        };
      }
    </script>
  </body>
</html>
<!-- SIDEBAR-ACTIVE-HILITE -->
<script>
  (() => {
    const p = location.pathname.replace(/\/+$/, "").toLowerCase();
    document.querySelectorAll(".sidebar a").forEach((a) => {
      try {
        const u = new URL(a.href, location.href);
        if (p.endsWith(u.pathname.replace(/\/+$/, "").toLowerCase())) a.classList.add("active");
      } catch (_) {}
    });
  })();
</script>
<!-- SITE-FOOTER START -->
<footer class="footer">
  <div class="container"><small>© Mind Engine • Playground</small></div>
</footer>
<!-- SITE-FOOTER END -->
